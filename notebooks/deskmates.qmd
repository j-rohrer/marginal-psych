---
title: "Example 3: Deskmates"
author: "Julia Rohrer"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
---

Before we start, let's execute a helper script that loads the necessary dependencies.

```{r}
source(here::here("scripts/load.R"))
```

# Overview

This document contains example 3, in which we analyze the effect of being seated next to each other on friendships, using Bayesian multilevel models.

# Bayesian multilevel regression model

```{r load_fit}
# Read the data
dat <- read.csv(here("data/deskmates.csv"))

# Arbitrary subset of 60 classes to make model-fitting less tedious
dat <- dat[dat$class_id %in% unique(dat$class_id)[1:60], ]

# Keep complete cases
dat <- dat[complete.cases(dat),]


# Label focal variables
dat <- transform(dat,
    gender_combination = factor(girl_match, label = c("Boys", "Mixed", "Girls")),
    deskmate = factor(deskmate, label = c("Different desk", "Same desk")))

# Rename to match labels in manuscript
dat <- dat |>
  rename(GPA_average = mean_gpa,
         GPA_difference = diff_gpa,
         friendship = friend,
         classroom = class_id,
         student1 = s1,
         student2 = s2)


# Display the first few rows of data
head(dat)
```

Fit the model and save it to avoid re-fitting every time.

```{r, eval = FALSE}
mod <- brm(
    friendship ~ deskmate + gender_combination + deskmate:gender_combination +
        GPA_average + GPA_difference + GPA_average:deskmate + GPA_difference:deskmate +
        (1 | classroom) + (1 | mm(student1, student2)),
    family = bernoulli(link = "logit"),
    data = dat,
    seed = 12345,
    cores = 4
)

# Save model fit
saveRDS(mod, file = here("fits/deskmates.rds"))
```

```{r}
# Load the fitted model
mod <- readRDS(here("fits/deskmates.rds"))

parameters(mod)
```

# Interpretation with `marginaleffects`

## What is the average treatment effect of being a deskmate on the log-odds of a friendship (link scale)?

```{r}
avg_comparisons(mod, variables = "deskmate", type = "link")
```

## What is the average treatment effect of being a deskmate on the probability of a friendship?

```{r}
ate <- avg_comparisons(mod, variables = "deskmate")
ate
```

## What is the average expected probability of a friendship between deskmates and non-deskmates?

```{r}
avg_predictions(mod, by = "deskmate")
```

## Comparing our treatment effect to the fast friends procedure
```{r}
#avg_comparisons(mod, variables = "deskmate",
#                equivalence = c(0.09, 0.11))
```

## What is the average treatment effect of being a deskmate on the probability of a friendship, at desks with different gender compositions?

```{r}
cmp <- avg_comparisons(mod, variables = "deskmate", by = "gender_combination")
```

### Pairwise comparisons, e.g.: Is the effect of sharing a desk stronger for students on girls-only desks, relative to the effect of sharing a desk for students on mixed-gender desks?

```{r}
avg_comparisons(mod,
                variables = "deskmate",
                by = "gender_combination",
                hypothesis = ~pairwise)

```


### Is the effect of sharing a desk stronger for students on gender-matched desks, relative to the effect of sharing a desk for students on mixed-gender desks?

```{r}
avg_comparisons(mod,
                variables = "deskmate",
                by = "gender_combination",
                hypothesis = "(b1 + b3)/2 = b2")

```

### Plotting the effects by gender

```{r}
plot_predictions(mod, by = c("gender_combination", "deskmate"))

plot_comparisons(mod, variables = "deskmate", by = "gender_combination")

```


## Conditioning on other variables in the model

### What is the average treatment effect of sharing a desk for students with high and low differences in GPA, accounting for gender?

```{r}
avg_comparisons(mod,
                variables = "deskmate",
                by = "GPA_difference",
                newdata = datagrid(GPA_difference = c(mean(dat$GPA_difference, na.rm = TRUE) - sd(dat$GPA_difference, na.rm = TRUE), 
                                                mean(dat$GPA_difference, na.rm = TRUE) + sd(dat$GPA_difference, na.rm = TRUE)),
                                   grid_type = "counterfactual"))

```


